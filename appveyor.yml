version: 4.0.{build}
clone_folder: c:\projects\nlog
build_script:
  - Msbuild.exe src/NLog.proj /verbosity:minimal /t:BuildTests /p:BuildSL5=true /p:BuildSL4=true /p:BuildNetFX35=true /p:BuildNetFX40=true /p:BuildNetFX45=true 
  - Msbuild.exe src/NLog.proj /verbosity:minimal /t:rebuild /p:BuildAllFrameworks=false /p:BuildWP8=true            /p:BuildLastMajorVersion=4.0.0 /p:AssemblyFileVersion=4.9.9 /p:BuildVersion=4.9.9
  - if defined build_with_xamarin Msbuild.exe src/NLog.proj /verbosity:minimal /t:rebuild /p:BuildAllFrameworks=false /p:BuildXamarinAndroid=true /p:BuildLastMajorVersion=4.0.0 /p:AssemblyFileVersion=4.9.9 /p:BuildVersion=4.9.9
  - if defined build_with_xamarin Msbuild.exe src/NLog.proj /verbosity:minimal /t:rebuild /p:BuildAllFrameworks=false /p:BuildXamarinIOS=true     /p:BuildLastMajorVersion=4.0.0 /p:AssemblyFileVersion=4.9.9 /p:BuildVersion=4.9.9
before_test:
  - tests\CreateTestUsers.cmd
test_script:
  - tools\CheckSourceCode\NLog.SourceCodeTests.exe no-interactive
  - xunit.console.clr4 "build\bin\Debug\.NET Framework 3.5\NLog.UnitTests.dll" /appveyor /noshadow
  - xunit.console.clr4 "build\bin\Debug\.NET Framework 4.0\NLog.UnitTests.dll" /appveyor /noshadow
  - xunit.console.clr4 "build\bin\Debug\.NET Framework 4.5\NLog.UnitTests.dll" /appveyor /noshadow
  - nuget.exe install OpenCover -ExcludeVersion
  - dir
  - OpenCover\tools\OpenCover.Console.exe -register:user -target:"%xunit20%\xunit.console.x86.exe" -targetargs:"\"C:\projects\nlog\build\bin\Debug\.NET Framework 4.5\NLog.UnitTests.dll\" -appveyor -noshadow"  -returntargetcode -filter:"+[NLog]* +[NLog.Extended]* -[NLog]JetBrains.Annotations.*" -excludebyattribute:*.ExcludeFromCodeCoverage* -hideskipped:All -output:coverage.xml
  - "SET PATH=C:\\Python34;C:\\Python34\\Scripts;%PATH%"
  - pip install codecov
  - codecov -f "coverage.xml"
    # When a pull request comes from a forked repo, the variable 'build_with_xamarin' is not defined because xamarin licensing isn't set up. (for details see https://github.com/NLog/NLog/pull/1062 )
    # That means xamarin-dependent .sln configurations (Android, iOS) won't be built or tested.
    # In that scenario, if the pull request destination is 'master', then fail and suggest alternative actions to the user.
    # Do this last, after all other build/test scripts have executed, so at least those build/test failures will reported first if they're broken
  - if exist parent_is_master.txt del /F parent_is_master.txt
  - if not defined build_with_xamarin perl tools/any_parent_is_master.pl parent_is_master.txt
  - if exist parent_is_master.txt tools\fail.cmd "NLog was not built for Android and iOS configurations. This occurs for pull requests from forked repos. The pull request moderator may choose to ignore this error. To avoid this error, choose a destination branch other than 'master' and complete the pull request, then do a non-forked pull request to 'master' to verify Android and iOS configurations still build OK. Or just do non-forked pull requests in the first place. =)"
  
after_test:
  - tests\DeleteTestUsers.cmd

deploy: off
# preserve "packages" directory in the root of build folder but will reset it if packages.config is modified
cache:
  - packages -> **\packages.config
